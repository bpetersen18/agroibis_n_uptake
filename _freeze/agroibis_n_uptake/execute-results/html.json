{
  "hash": "77fc2cbb7b868185a86b20ffdb620591",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Agro-IBIS VSF: Plant N Uptake\"\nauthor: \"Bryan Petersen\"\ndate: \"2025-04-03\"\nformat:\n  html:\n    code-fold: true\n---\n\n\n## Equation Overview\nThe equation for potential plant N uptake for a given soil layer, k, and location, i, is the following:  \n\n$$\\mathrm{tnuptake(i,k) = max(alphac \\times stressl(i,k), wsupply) \\times availn \\times [smsoil(i,k) + smsoln(i,k)]}$${#eq-tnuptake}\n\nwhere:  \n - $\\mathrm{tnuptake(i,k)}$ is the total N uptake by plants in the soil layer, k, and location, i.  \n - $\\mathrm{alphac}$ is the minimum N uptake rate in low soil moisture conditions.  \n - $\\mathrm{stressl(i,k)}$ is soil moisture stress factor for the lower canopy for each soil layer, k, and location, i.  \n - $\\mathrm{wsupply}$ is the supply of water to the plant roots a single soil layer.  \n - $\\mathrm{availn}$ is the fraction of inorganic N pool available to plants in a single soil layer. This is set to 1 in params.crp.  \n - $\\mathrm{smsoil(i,k)}$ is immobile inorganic nitrogen (ammonium) in soil in a soil layer, k, and location, i.  \n - $\\mathrm{smsoln(i,k)}$ is mobile inorganic nitrogen (nitrate) in soil in a soil layer, k, and location, i.  \n \n## Unit Analysis  \n Based on the documentation alone, the units for the variables in the equation are as follows:  \n - $\\mathrm{tnuptake(i,k)}$ is in $\\mathrm{kg\\,N\\,hr^{-1}}$  \n - $\\mathrm{alphac}$ is in $\\mathrm{mm\\,\\,d^{-1}}$  \n - $\\mathrm{stressl(i,k)}$ is unitless  \n - $\\mathrm{wsupply}$ is in $\\mathrm{kg \\, H_{2}O \\, m^{-2} \\, s^{-1}}$  \n - $\\mathrm{availn}$ is unitless  \n - $\\mathrm{smsoil(i,k)}$ is in $\\mathrm{kg \\, solute \\, m^{-2}}$  \n - $\\mathrm{smsoln(i,k)}$ is in $\\mathrm{kg \\, solute \\, m^{-2}}$  \n \nI will assume that the units of $\\mathrm{tnuptake(i,k)}$ should be $\\mathrm{kg\\,N\\,m^{-2}\\,hr^{-1}}$.  \n\nBefore $\\mathrm{wsupply}$ is used in @eq-tnuptake, it is multiplied by $\\mathrm{dtime}$, which is the number of seconds in a hour. This converts $\\mathrm{wsupply}$ to $\\mathrm{kg \\, H_{2}O \\, m^{-2} \\, hr^{-1}}$.  \n\nI will also assume that solute in $\\mathrm{smsoil(i,k)}$ and $\\mathrm{smsoln(i,k)}$ is represented by $\\mathrm{kg \\, N}$ in $\\mathrm{NH_{4}^{+}}$ and $\\mathrm{NO_{3}^{-}}$, respectively.\n\nAssuming $\\mathrm{wsupply}$ is larger than $\\mathrm{alphac \\times stressl(i,k)}$ and evaluating the units on the right side of @eq-tnuptake, we have:  \n$$\\mathrm{kg \\, H_{2}O \\, m^{-2} \\, hr^{-1} \\times (kg \\, N \\, m^{-2} + kg \\, N \\, m^{-2})}$${#eq-tnuptake-units}\n\nThis simplifies to:\n$$\\mathrm{kg^{2} \\, H_{2}O \\times N \\, m^{-4} \\, hr^{-1}}$${#eq-tnuptake-units-simplified}\n\nIn order for the units to be consistent with $\\mathrm{tnuptake(i,k)}$, the units of $\\mathrm{smsoil(i,k)}$ and $\\mathrm{smsoln(i,k)}$ must be $\\mathrm{kg \\, N \\, kg^{-1} \\, H_{2}O}$. \n\n## Calculating smsoil\n$\\mathrm{smsoil(i,k)}$ is initialized in solute.f using the following equation:\n\n$$\\mathrm{smsoil(i,k) = co \\times \\frac{snode(k)}{cndepth}}$${#eq-smsoil}\n\nwhere:  \n - $\\mathrm{co \\: [kg \\, solute \\, m^{-2}]}$ is the initial total solute mass for the soil profile.  \n - $\\mathrm{snode(k) \\: [m]}$ is the average soil layer depth for $\\mathrm{k^{th}}$ soil layer.  \n - $\\mathrm{cndepth \\: [m]}$ is the average depth of bottom soil layer.  \n \nBased on the documented units for the variables in @eq-smsoil, the units for $\\mathrm{smsoil(i,k)}$ should be $\\mathrm{kg \\, solute \\, m^{-2}}$, and not $\\mathrm{kg \\, N \\, kg^{-1} \\, H_{2}O}$. This is inconsistent with the units required for the calculation of $\\mathrm{tnuptake(i,k)}$ in @eq-tnuptake.\n \n## Magnitude of Variables\nIn a corn simulation using Agro-IBIS VSF, the annual plant N uptake supply was $\\mathrm{1.5 \\times 10^{-2}\\, kg \\, N \\, m^{-2}}$ while the actual annual plant N uptake was $\\mathrm{1.4 \\times 10^{-2}\\, kg \\, N \\, m^{-2}}$. Abendroth et al. (2011) reports that average annual corn N uptake is $\\mathrm{200 \\, lb \\, N \\, ac^{-1}}$, which is equivalent to $\\mathrm{2.2 \\times 10^{-2} \\, kg \\, N \\, m^{-2}}$. This is consistent with the values from the Agro-IBIS VSF simulation.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(lubridate)\nlibrary(data.table)\nlibrary(gganimate)\n\n# Define soil layer depths (in meters)\nlayer_depths <- c(\n  0.00500, 0.01192, 0.02076, 0.03152, 0.04419, 0.05879, 0.07530, 0.09374, 0.11409, 0.13636,\n  0.16056, 0.18667, 0.21470, 0.24465, 0.27652, 0.31030, 0.34601, 0.38364, 0.42318, 0.46465,\n  0.50803, 0.55333, 0.60056, 0.64970, 0.70076, 0.75374, 0.80864, 0.86545, 0.92419, 0.98485,\n  1.04742, 1.11192, 1.17833, 1.24667, 1.31692, 1.38909, 1.46318, 1.53919, 1.61712, 1.69697,\n  1.77874, 1.86242, 1.94803, 2.03556, 2.12500, 2.21636, 2.30965, 2.40485, 2.50197, 2.60101,\n  2.70197, 2.80485, 2.90965, 3.01636, 3.12500, 3.23556, 3.34803, 3.46242, 3.57874, 3.69697,\n  3.81712, 3.93919, 4.06318, 4.18909, 4.31692, 4.44667, 4.57833, 4.71192, 4.84742, 4.98485,\n  5.12419, 5.26546, 5.40864, 5.55374, 5.70076, 5.84970, 6.00056, 6.15333, 6.30803, 6.46465,\n  6.62318, 6.78364, 6.94601, 7.11030, 7.27652, 7.44465, 7.61470, 7.78667, 7.96056, 8.13636,\n  8.31409, 8.49374, 8.67530, 8.85879, 9.04419, 9.23152, 9.42076, 9.61192, 9.80500, 10.00000\n)\n\nparse_soil_data <- function(file_path) {\n  # Read file quickly with data.table\n  content <- fread(file_path, sep = NULL, header = FALSE, fill = TRUE)[[1]]\n  \n  # Find all date lines and extract dates\n  date_lines <- str_which(content, \"starting - year/month/day: \\\\d{4}/\\\\s?\\\\d{1,2}/\\\\s?\\\\d{1,2}\")\n  dates <- ymd(str_extract(content[date_lines], \"\\\\d{4}/\\\\s?\\\\d{1,2}/\\\\s?\\\\d{1,2}\") %>% \n    str_replace_all(\"/\", \"-\"))\n  \n  # Find all soil data blocks (each block has 3 lines: layer, smsoil, smsoln)\n  soil_starts <- str_which(content, \"^soil layer:\")\n  \n  \n  # Pre-allocate results data.table\n  result <- data.table(\n    date = as.Date(rep(NA, length(soil_starts))),\n    layer = integer(length(soil_starts)),\n    depth = numeric(length(soil_starts)),\n    smsoil = numeric(length(soil_starts)),\n    smsoln = numeric(length(soil_starts))\n  )\n  \n  # Map each soil reading to its corresponding date\n  date_indices <- findInterval(soil_starts, date_lines)\n  \n  # Process soil data\n  result[, `:=`(\n    date = dates[date_indices],\n    layer = as.integer(str_extract(content[soil_starts], \"\\\\d+\")),\n    depth = layer_depths[as.integer(str_extract(content[soil_starts], \"\\\\d+\"))],\n    smsoil = as.numeric(str_extract(content[soil_starts + 1], \"[0-9.E+-]+\")),\n    smsoln = as.numeric(str_extract(content[soil_starts + 2], \"[0-9.E+-]+\"))\n  )]\n  \n  # Remove any NA rows\n  result <- result[complete.cases(result)]\n  \n  return(as_tibble(result))\n}\n\n# Parse the raw data\nsoil_data <- parse_soil_data(\"data/sabr_corn.txt\")\n\n# Average the data by date and layer\ndaily_soil_data <- soil_data %>%\n  pivot_longer(cols = c(smsoil, smsoln), names_to = \"n_type\", values_to = \"value\") %>%\n  group_by(date, depth, n_type) %>%\n  summarise(value = mean(value)) %>%\n  ungroup()\n\n\n# Plot the smsoln and smsoil profile data and animate it\nsoil_n_gif <- daily_soil_data %>%\n  filter(year(date) == 2019) %>%\n  ggplot(aes(x = value, y = depth)) +\n  geom_path() +\n  facet_wrap(~ n_type, ncol = 2, scales = \"free_x\") +\n  scale_y_reverse() +\n  scale_x_log10() +\n  theme_bw() +\n  labs(y = \"Depth (m)\", x = \"Value\", title = \"Immobile and Mobile Inorganic N on {frame_time}\") +\n  transition_time(date) +\n  ease_aes('linear')\n\n# Save the animation\nanim_save(\"soil_n.gif\", animate(soil_n_gif, renderer = gifski_renderer()))\n\nknitr::include_graphics(\"soil_n.gif\")\n```\n\n::: {.cell-output-display}\n![Simulated mobile and immobile inorganic N under first year corn crop.](soil_n.gif)\n:::\n:::\n\n\n\nIn the top soil layer on May 7th, the mobile and immobile nitrogen pools were $\\mathrm{3.4 \\times 10^{-5}}$ and $\\mathrm{5.6 \\times 10^{-4}}$, respectively. If these numbers were concentrations, they would 34 ppm and 560 ppm, respectively. The mobile N pool is on the same order of magnitude as values shown in this Iowa State University Extension article (https://crops.extension.iastate.edu/cropnews/2022/06/using-late-spring-soil-nitrate-test-2022).\n\n",
    "supporting": [
      "agroibis_n_uptake_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}